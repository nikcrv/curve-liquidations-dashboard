# Soft Liquidation Report v11 - Backup
## Дата создания бэкапа: 2025-09-04

## Описание
Анализатор софт-ликвидаций (soft liquidations) в протоколах Curve Finance / LlamaLend с поддержкой реоупенингов (повторных открытий позиций).

## Основной функционал

### Класс `SoftLiquidationAnalyzerWithReopenings`
Основной класс для анализа софт-ликвидаций с учетом повторных открытий позиций.

#### Ключевые методы:
1. **`__init__`** - Инициализация с загрузкой конфигурации
2. **`find_block_by_timestamp`** - Бинарный поиск блока по временной метке
3. **`scan_deposits`** - Сканирование событий депозита
4. **`scan_soft_liquidations`** - Поиск софт-ликвидаций
5. **`scan_controller`** - Сканирование контроллера за период
6. **`analyze_all_controllers`** - Анализ всех контроллеров
7. **`generate_report`** - Генерация отчета с статистикой

### Особенности версии v11

#### Поддержка реоупенингов
- Отслеживание повторных открытий позиций после софт-ликвидаций
- Правильный учет множественных софт-ликвидаций одного пользователя
- Корректная обработка последовательных депозитов и ликвидаций

#### События которые отслеживаются:
1. **Deposit** - открытие/пополнение позиции
2. **SoftLiquidation** - софт-ликвидация позиции
3. **Borrow** - заимствование
4. **Repay** - погашение долга

### Структура данных софт-ликвидации

```json
{
  "user": "0x...",
  "controller": "0x...",
  "network": "ethereum",
  "liquidation_time": "2024-08-15T10:30:00",
  "block_number": 12345678,
  "tx_hash": "0x...",
  "collateral_amount": 1000.0,
  "debt_amount": 500.0,
  "reopening": false,  // Является ли реоупенингом
  "position_number": 1  // Номер позиции для пользователя
}
```

## Файлы в бэкапе

### Основные файлы
1. **soft_liquidation_report_v11.py** - Главный скрипт анализатора
2. **config.json** - Конфигурация сетей и контроллеров
3. **controller_abi.json** - ABI контрактов

### Результаты сканирования
4. **soft_liquidation_events.json** - События софт-ликвидаций
5. **soft_liquidations_analysis.json** - Анализ ликвидаций
6. **all_soft_liquidations_20250829_215749.json** - Все софт-ликвидации
7. **soft_liquidation_users_20250829_215127.json** - Данные пользователей
8. **soft_liquidation_users_20250829_215127.csv** - CSV экспорт
9. **tvl_soft_liquidation_20250829_231622.json** - TVL анализ
10. **tvl_soft_liquidation_20250829_231723.json** - TVL анализ (обновленный)

## Запуск

### Базовый запуск
```bash
python3 soft_liquidation_report_v11.py
```

### С параметрами периода
```bash
python3 soft_liquidation_report_v11.py --start-date 2024-07-01 --end-date 2024-09-01
```

### Параметры
- `--start-date` - Начальная дата (YYYY-MM-DD)
- `--end-date` - Конечная дата (YYYY-MM-DD)
- `--network` - Конкретная сеть (ethereum, arbitrum, etc.)

## Отличия от хард-ликвидаций

| Параметр | Софт-ликвидация | Хард-ликвидация |
|----------|-----------------|-----------------|
| Инициатор | Автоматически системой | Ликвидатор |
| Потери | Минимальные (~1-2%) | 6-30% |
| Частичность | Да, частичная | Полная |
| Восстановление | Возможно | Невозможно |
| События | SoftLiquidation | Liquidate |

## Статистика из последнего запуска

- Период анализа: 2024-07-01 до 2024-08-29
- Обработано контроллеров: ~50+
- Найдено софт-ликвидаций: варьируется
- Уникальных пользователей: варьируется

## Производительность

- Chunk size: 5000 блоков
- Параллельности: Нет (последовательное сканирование)
- Среднее время: 2-4 часа для полного периода

## Зависимости

```bash
pip install web3 pandas
```

## Важные замечания

1. **Реоупенинги** - Версия v11 корректно обрабатывает случаи, когда пользователь повторно открывает позицию после софт-ликвидации
2. **Множественные события** - Поддержка множественных софт-ликвидаций одного пользователя
3. **Временные метки** - Использует блокчейн временные метки для точной датировки
4. **Rate limiting** - Встроенная обработка ограничений RPC

## Контакты и поддержка

При возникновении вопросов обращайтесь к документации Curve Finance или используйте issue tracker проекта.